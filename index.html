<html>
<head>
  <title>P2</title>
  <script src="https://d3js.org/d3.v6.min.js"></script>
  <script src="https://d3js.org/topojson.v3.min.js"></script>
  <style>

  body {
    color: grey;
    font-family: sans-serif;
  }

  h3 {
    font-size: 15px;
    font-weight: lighter;
    margin-top: 1%;
    margin-right: 1%;
    text-align: right;
  }

  .county {
    fill: lightgrey;
  }

  .countyOutline {
    stroke: white;
    stroke-width: 0.5px;
    fill: none;
  }
/*
  #currentRating {
    font-weight: bold;
  }*/

  .slider {
    width: 450px;
  }

  .page-wrapper {
    display: flex;
  }

  .left-column {
    flex: 35%;
  }

  .right-column {
    flex: 65%;
  }

  #filtergroup {
    margin-top: 50px;
    margin-left: 90px;
  }

  .slider_title {
    font-size: 20px;
    font-weight: lighter;
    display: block;
    margin-bottom: 3%;
    margin-top: 10%;
  }

  #cuisine_filter {
    margin-top: 10%;
    font-weight: lighter;
    font-size: 20px;
  }

  .checkbox {
    margin-bottom: 6%;
    margin-left: 1.5%;
  }

  h2 {
    font-weight: lighter;
    font-size: 60px;
    margin-left: 80px;
    margin-top: 150px;
  }

  .kyoto {
    color: red;
    font-size: 85px;
    margin-bottom: 0px;
  }

  </style>
</head>

<body>
  <!-- name and netid -->
<!--   <h3>Name: Kevin Lee, NetId: ksl66</h3>
  <h3>Name: Yulu Cao, NetId: yc758</h3> -->

<h3>Kevin Lee [ksl66] | Yulu Cao [yc758]</h3>

<div class="page-wrapper">

  <div class="left-column">


  <h2><span class="kyoto"> KYOTO:</span> <br>Where are You Setting Up ?</h2>

    <div id="filtergroup">
      <div class="filter">
        <label for="rating" class="slider_title">Filter on Rating</label>
        <input id="rateSlider" class="slider" type="range" value="3" min="3" max="4.2" step="0.1">
        <span id="currentRating"> </span>
      </div>

      <div class="filter">
        <label for="price" class="slider_title">Filter on Price</label>
        <input id="priceSlider" class="slider" type="range" value="1" min="1" max="12" step="1">
        <span id="currentPrice"> </span>
      </div>
    </div>

  </div>


  <div class="right-column">

  <svg id="graph" height="1000" width="1200" style="margin:20px"></svg>

  <script>

  // Initiation
  const svg = d3.select("#graph");
  const width = svg.attr("width");
  const height = svg.attr("height");
  const margin = { top: 20, right: 300, bottom: 20, left:20};
  const mapWidth = width - margin.left - margin.right;
  const mapHeight = height - margin.top - margin.bottom;
  const map = svg.append("g")
                 .attr("transform","translate("+margin.left+","+margin.top+")");
  // TODO: need to change the transform function of the res_description
  // restaurant description label
  const res_description = svg.append("g")
                             .attr("id", "res_description")
                             .attr("transform", "translate(800, 400)");
  const res_name = res_description.append("text")
                                  .attr("id", "res_name")
                                  .attr("x", 0)
                                  .attr("y", 0);
  const res_jp_name = res_description.append("text")
                                  .attr("id", "res_jp_name")
                                  .attr("x", 0)
                                  .attr("y", 20);
  const res_price = res_description.append("text")
                                  .attr("id", "res_price")
                                  .attr("x", 0)
                                  .attr("y", 40);
  const res_rating = res_description.append("text")
                                  .attr("id", "res_rating")
                                  .attr("x", 0)
                                  .attr("y", 60);
  // region description label
  const region_description = svg.append("g")
                                .attr("id", "region_description")
                                .attr("transform", "translate(800, 400)");
  const region_name = res_description.append("text")
                                  .attr("id", "region_name")
                                  .attr("x", 0)
                                  .attr("y", 0);
  // cuisine filter
  const cuisine_filter = d3.select("#filtergroup").append("div")
                           .attr("id", "cuisine_filter")
                           .attr("class", "filter");

  const requestData = async () => {

    const kyoto = await d3.json("../kyoto_all.json");
    console.log(kyoto);

    // filter the topojson to contain only 京都市
    for (i = kyoto.objects.kyoto.geometries.length - 1; i >= 0; i -= 1) {
      if (escape(kyoto.objects.kyoto.geometries[i].properties.GST_NAME) !== "%u4EAC%u90FD%u5E02") {
        kyoto.objects.kyoto.geometries.splice(i, 1);
      };
    };

    // further filter the topojson to contain only central Kyoto, based off X & Y-coordinate values
    var map_upper_boundary = 35.06777;
    var map_left_boundary = 135.66;

    for (i = kyoto.objects.kyoto.geometries.length - 1; i >= 0; i -= 1) {
      if (kyoto.objects.kyoto.geometries[i].properties.Y_CODE > map_upper_boundary) { 
        kyoto.objects.kyoto.geometries.splice(i, 1);
      } else if (kyoto.objects.kyoto.geometries[i].properties.X_CODE < map_left_boundary) {
        kyoto.objects.kyoto.geometries.splice(i, 1);
    }};

    // draw the map
    var city = topojson.feature(kyoto, kyoto.objects.kyoto);
    var cityMesh = topojson.mesh(kyoto, kyoto.objects.kyoto);
    var projection = d3.geoMercator().fitSize([mapWidth, mapHeight], city);
    var path = d3.geoPath().projection(projection);

    kyoto_areas = [];
    kyoto.objects.kyoto.geometries.forEach( (d, i) => {
      kyoto_areas.push(d.properties.CSS_NAME);
    });

    map.selectAll("path.county").data(city.features)
       .join("path")
       .attr("class", "county")
       .attr("d", path)
       .on("mouseover", function() {
         d3.select(this)
           .transition().duration(100)
           .style("fill", "grey");

         let name = d3.select(this).datum().properties.MOJI;
         d3.select("#region_name")
           .text(name);
       })
       .on("mouseout", function() {
         d3.select(this)
           .transition().duration(100)
           .style("fill", "lightgrey");

         d3.select("#region_name")
           .text(name);
       });

    map.append("path").datum(city)
       .attr("class","countyOutline")
       .attr("d", path);

    // load restaurant data
    const restaurants = await d3.json("../kyoto_restaurants_processed.json");
    console.log(restaurants);

    cuisine = [];
    price = [];
    restaurants.forEach( (d, i) => {
    // Use the projection just like a scale to convert from lng/lat to pixels
      d.position = projection([d.Long, d.Lat]);
      cuisine.push(d.cuisine);
      price.push(d.price);
    });
    console.log(restaurants);
    let uniqueCuisine = [...new Set(cuisine)];
    console.log(uniqueCuisine);
    let uniquePrice = [...new Set(price)];
    console.log(uniquePrice);

    // create a cuisine scale
    cuisineScale = d3.scaleOrdinal()
                  .domain(uniqueCuisine)
                  .range(d3.schemeTableau10);

    // cuisine filter
    uniqueCuisine.forEach( function(d, i) {
      // append checkbox
      d3.select("#cuisine_filter")
        .append("input")
        .attr("class", "checkbox")
        .attr("type", "checkbox")
        .attr("value", d)
        .attr("checked", true);
      // append label
      d3.select("#cuisine_filter")
        .append("label")
        .text(d)
        .style("color",cuisineScale(d));
    });

    const ratingextent = d3.extent(restaurants, d => d['rating']);
    console.log(ratingextent); // the lowest rating is 3.0, and the highest is 4.2. Adjust slider to accomodate

    // create a price scale; change later in Python to numbers and not strings
    let price_ranges = [" ～￥999", "￥1000～￥1999", "￥2000～￥2999", "￥3000～￥3999", "￥4000～￥4999", "￥5000～￥5999", "￥6000～￥7999", "￥8000～￥9999", "￥10000～￥14999", "￥15000～￥19999", "￥20000～￥29999", "￥30000～"];

    const priceScale = d3.scaleOrdinal()
      .domain(price_ranges)
      .range([1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]);

    // create a reverse price scale for calculating the input of the price slider
    const reversePriceScale = d3.scaleOrdinal()
      .domain([1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12])
      .range(price_ranges);


    const displayPriceScale = d3.scaleOrdinal()
      .domain([1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12])
      .range(["~999 JPY", "1000~1999 JPY", "2000~2999 JPY", "3000~3999 JPY", "4000~4999 JPY", "5000~5999 JPY", "6000~7999 JPY", "8000~9999 JPY", "10000~14999 JPY", "15000~19999 JPY", "20000~29999 JPY", "30000+ JPY"]);


    // Draw circles using the positions we just made
    function showCircles(rating, price, cuisine) {

      // filter restaurants based on the input rating and price
      var data = restaurants;
      data = data.filter( (d) => {
        return d.rating >= rating && priceScale(d.price) >= price &&  cuisine.includes(d.cuisine);
        // we show restaurants that have the specified price or below ? might be good to have an option for users to tick if they want to see restaurants below or above the indicated price
      });

      map.selectAll("circle.dot").data(data)
        .join("circle")
        .attr('class','dot')
        .attr("r", 2.5)
        .attr("fill", d => cuisineScale(d.cuisine))
        .attr("cx", d => d.position[0])
        .attr("cy", d => d.position[1])
        .attr("opacity", 1)
        .on("mouseover", function() {
             d3.select(this)
               .transition().duration(100)
               .attr("r", 5);

             let name = d3.select(this).datum()["name"];
             let jp_name = d3.select(this).datum()["japan_name"];
             let price = d3.select(this).datum()["price"];
             let rating = d3.select(this).datum()["rating"];
             d3.select("#res_name")
               .text("NAME:" + name);
             d3.select("#res_jp_name")
               .text("JAPANESE NAME:" + jp_name);
             d3.select("#res_price")
               .text("AVG PRICE:" + price);
             d3.select("#res_rating")
               .text("RATING:" + rating);
           })
           .on("mouseout", function() {
             d3.select(this)
               .transition().duration(100)
               .attr("r", 2.5);

             d3.select("#res_description").selectAll("text")
               .text("");
           });
    }

    var current_rating = d3.select("#rateSlider").attr("value");
    var current_price = d3.select("#priceSlider").attr("value");
    var current_cuisine = uniqueCuisine;
    showCircles(current_rating, current_price, current_cuisine);

    // making the rating slider work
    d3.select("#rateSlider").on("input", function() {
      current_rating = d3.select("#rateSlider").attr("value");
      showCircles(this.value, current_price, current_cuisine);
      d3.select("#currentRating")
        .text(this.value);
    });

    d3.select("#priceSlider").on("input", function() {
      current_price = d3.select("#priceSlider").attr("value");
      showCircles(current_rating, this.value, current_cuisine);
      d3.select("#currentPrice")
        .text(displayPriceScale(this.value));
    });

    d3.selectAll(".checkbox").on("change", function() {
      current_cuisine = [];
      d3.selectAll(".checkbox").each(function() {
        current_box = d3.select(this);
        if(current_box.property("checked")){
          current_cuisine.push(current_box.property("value"));
        };
      // showCircles(current_rating, current_price, current_cuisine);
      });
      showCircles(current_rating, current_price, current_cuisine);
    });


  }; // end of requestData async data load

  requestData();

  </script>

</div>

</div>
</body>
</html>
